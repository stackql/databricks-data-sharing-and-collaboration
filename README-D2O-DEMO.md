# D2O Delta Sharing Demo

This demo showcases **Databricks-to-Open (D2O) Delta Sharing**, where a data provider using Databricks shares data with external recipients who do not have access to Databricks.

## Overview

The demo consists of two parts:

1. **Provider Side** (Databricks): Creates the share, recipient, and generates the activation link
2. **Recipient Side** (Docker + Jupyter): Accesses the shared data using open-source tools

## Architecture

```
┌─────────────────────────┐
│  Databricks Provider    │
│  (Unity Catalog)        │
│                         │
│  - Creates Share        │
│  - Creates Recipient    │
│  - Generates Token      │
└───────────┬─────────────┘
            │
            │ Delta Sharing Protocol
            │ (Bearer Token Auth)
            │
┌───────────▼─────────────┐
│  Docker Container       │
│  (Recipient Side)       │
│                         │
│  - Jupyter Lab          │
│  - Python + pandas      │
│  - delta-sharing lib    │
│  - seaborn/matplotlib   │
└─────────────────────────┘
```

## Prerequisites

### Provider Side
- Databricks workspace with Unity Catalog enabled
- Permission to create shares and recipients
- The provider notebook has been run: `provider-notebooks/Module 2 - Delta Sharing Deep Dive/2.3 DEMO Implementing D2O Delta Sharing.ipynb`
- Credential file generated at: `.creds/config.share`

### Recipient Side
- Docker installed and running
- PowerShell (Windows) or Bash (Linux/Mac)
- Port 8888 available for Jupyter Lab

## Quick Start

### Step 1: Run the Provider Notebook

1. Open `provider-notebooks/Module 2 - Delta Sharing Deep Dive/2.3 DEMO Implementing D2O Delta Sharing.ipynb` in Databricks
2. Run all cells to:
   - Create the share (`external_retail`)
   - Create the open recipient (`partner_co`)
   - Generate the activation link
3. Download the credential file and save it to `.creds/config.share`

### Step 2: Run the Recipient Demo

**Build the Docker image (one time):**
```bash
docker build -t d2o-delta-sharing-demo .
```

**Run the container:**

**PowerShell (Windows):**
```powershell
docker run -d --name d2o-demo -p 8888:8888 --env-file .\.creds\config.share -e DELTA_SHARING_CONFIG="$(Get-Content .\.creds\config.share -Raw)" -v "${PWD}\external_jupyter_notebooks:/workspace" d2o-delta-sharing-demo
```

Or using a mounted file approach:
```powershell
docker run -d --name d2o-demo -p 8888:8888 -v "${PWD}\.creds\config.share:/tmp/config.share:ro" -v "${PWD}\external_jupyter_notebooks:/workspace" d2o-delta-sharing-demo
```

**Bash (Linux/Mac):**
```bash
docker run -d --name d2o-demo -p 8888:8888 -v "$(pwd)/.creds/config.share:/tmp/config.share:ro" -v "$(pwd)/external_jupyter_notebooks:/workspace" d2o-delta-sharing-demo
```

### Step 3: Access Jupyter Lab

1. Open your browser to: http://localhost:8888
2. Open the notebook: `d2o_example.ipynb`
3. Run the cells to see the demo in action!

**To stop the container:**
```bash
docker stop d2o-demo
docker rm d2o-demo
```

## What the Demo Shows

The recipient notebook (`external_jupyter_notebooks/d2o_example.ipynb`) demonstrates:

1. ✅ **Loading credentials** from environment variable
2. ✅ **Connecting** to the Delta Share using the delta-sharing library
3. ✅ **Listing shares** available to the recipient
4. ✅ **Listing schemas and tables** in the share
5. ✅ **Querying data** using pandas (customers and sales transactions)
6. ✅ **Data analysis** with summary statistics
7. ✅ **Visualizations** using seaborn and matplotlib:
   - Sales distribution histograms
   - Transaction box plots
   - Time series analysis
   - Top customers analysis
   - Customer demographics
   - Revenue analysis by segment

## Project Structure

```
.
├── .creds/
│   └── config.share                    # Generated by provider notebook
├── external_jupyter_notebooks/
│   └── d2o_example.ipynb              # Recipient demo notebook
├── provider-notebooks/
│   └── Module 2 - Delta Sharing Deep Dive/
│       └── 2.3 DEMO Implementing D2O Delta Sharing.ipynb
├── Dockerfile                          # Container definition
├── run-d2o-demo.ps1                   # PowerShell run script
├── run-d2o-demo.sh                    # Bash run script
└── README-D2O-DEMO.md                 # This file
```

## Docker Container Details

### Image Contents
- Python 3.10
- Jupyter Lab
- delta-sharing library
- pandas
- seaborn
- matplotlib
- numpy

### Environment Variables
- `DELTA_SHARING_CONFIG`: JSON content of the config.share file

### Volumes
- `./external_jupyter_notebooks` → `/workspace` (read/write access to notebooks)

### Ports
- `8888`: Jupyter Lab web interface

## Managing the Container

### View Logs
```bash
docker logs d2o-demo
```

### Stop the Container
```bash
docker stop d2o-demo
```

### Remove the Container
```bash
docker rm d2o-demo
```

### Restart the Demo
Just run the script again - it will automatically clean up and restart:
```powershell
.\run-d2o-demo.ps1
```

## Troubleshooting

### Docker not running
**Error:** "Docker is not running"  
**Solution:** Start Docker Desktop and wait for it to fully initialize

### Port 8888 already in use
**Error:** "Bind for 0.0.0.0:8888 failed: port is already allocated"  
**Solution:** Stop any other Jupyter instances or change the port in the run script

### config.share not found
**Error:** "config.share not found"  
**Solution:** Run the provider notebook first to generate the credential file

### Cannot connect to Delta Share
**Error:** Connection errors in the notebook  
**Solutions:**
- Verify the token hasn't expired (check `expirationTime` in config.share)
- Ensure the recipient has been granted access to the share
- Check network connectivity

### Visualizations not displaying
**Solution:** Ensure you're running in Jupyter Lab (not Jupyter Notebook classic)

## Security Considerations

🔒 **Important Security Notes:**

1. **Credential Protection**: The `config.share` file contains a bearer token - treat it as a secret
2. **Token Expiration**: Tokens have an expiration date - rotate them before they expire
3. **Access Control**: The recipient only has access to explicitly shared tables
4. **No Write Access**: Recipients can only read data, never modify the source
5. **Audit Logging**: All access is logged on the provider side

## Benefits of D2O Delta Sharing

- 🚀 **No Data Duplication**: Recipients access live data without copying
- 🔒 **Secure**: Token-based authentication with configurable expiration
- ⚡ **Real-time**: Always get the latest data from the provider
- 💰 **Cost-effective**: No storage costs for recipients
- 🛠️ **Tool Agnostic**: Use any tool supporting Delta Sharing
- 🌐 **Open Standard**: Based on the open Delta Sharing protocol

## Next Steps

After running this demo, you can:

1. **Integrate with BI Tools**: Use the same credentials with Power BI, Tableau, etc.
2. **Automate Workflows**: Schedule Python scripts to process shared data
3. **Build Applications**: Create data apps that consume Delta Shares
4. **Explore OIDC**: Set up more secure authentication using OIDC federation

## Additional Resources

- [Delta Sharing Documentation](https://docs.databricks.com/en/delta-sharing/index.html)
- [Delta Sharing Open Protocol](https://github.com/delta-io/delta-sharing)
- [Python delta-sharing library](https://github.com/delta-io/delta-sharing/tree/main/python)

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Review the provider notebook for setup issues
3. Check Docker logs: `docker logs d2o-demo`
4. Review Databricks documentation

---

**© 2025 Databricks, Inc. All rights reserved.**
